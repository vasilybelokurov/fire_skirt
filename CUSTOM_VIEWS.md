# Custom camera views (full guide)

This document explains, in detail, how to define custom camera views in this pipeline. It covers the `views.json` format, how SKIRT consumes it, how to generate or edit it safely, and the exact commands to rebuild the `.ski` and run.

## 1) Where views live

- The pipeline uses `run/views.json` as the **single source of truth** for camera directions.
- It is generated by `code/make_views.py` (Fibonacci sphere), but you can **edit it manually** or **replace it with your own file**.

## 2) What `views.json` contains

`views.json` is a JSON object with metadata and a list of view entries:

```json
{
  "num_views": 32,
  "method": "fibonacci_sphere",
  "created_utc": "2026-02-09T21:56:56Z",
  "views": [
    {
      "index": 0,
      "theta_deg": 14.361511562916563,
      "phi_deg": 0.0,
      "dir": [0.24803918541230535, 0.0, 0.96875]
    }
  ]
}
```

Each view entry contains:

- `index` (int): a unique ID used in filenames like `view_015`.
- `theta_deg` (float): polar angle in degrees.
- `phi_deg` (float): azimuthal angle in degrees.
- `dir` (array of 3 floats): unit direction vector `[dx, dy, dz]`.

## 3) Coordinate conventions

We use a standard spherical coordinate convention:

- `theta` = polar angle from +z axis.
  - `theta = 0°` → pointing along +z.
  - `theta = 90°` → in the x–y plane.
  - `theta = 180°` → along −z.
- `phi` = azimuth in the x–y plane.
  - `phi = 0°` → +x axis.
  - `phi = 90°` → +y axis.

The direction vector corresponding to `(theta, phi)` is:

```
dx = sin(theta) * cos(phi)
dy = sin(theta) * sin(phi)
dz = cos(theta)
```

where `theta` and `phi` are in radians for the trig functions.

## 4) How SKIRT uses these angles

`code/build_ski.py` turns each view into a SKIRT instrument entry:

- `theta_deg` → `inclination` in the SKIRT instrument
- `phi_deg` → `azimuth` in the SKIRT instrument

These become:

```xml
<FrameInstrument instrumentName="view_015" distance="10 Mpc"
  inclination="88.209215 deg" azimuth="97.383539 deg" roll="0 deg"
  fieldOfViewX="40 kpc" fieldOfViewY="40 kpc" numPixelsX="1024" numPixelsY="1024"/>
```

## 5) Option A: Manually edit `views.json`

### Step‑by‑step

1) Open `run/views.json`.
2) Replace the `views` array with your own view definitions.
3) Update `num_views` to match the number of entries.
4) Run `build_ski.py` to regenerate the `.ski`.

Example with three custom views:

```json
{
  "num_views": 3,
  "method": "custom",
  "created_utc": "2026-02-09T00:00:00Z",
  "views": [
    {"index": 0, "theta_deg": 90.0, "phi_deg": 0.0, "dir": [1.0, 0.0, 0.0]},
    {"index": 1, "theta_deg": 90.0, "phi_deg": 90.0, "dir": [0.0, 1.0, 0.0]},
    {"index": 2, "theta_deg": 0.0,  "phi_deg": 0.0, "dir": [0.0, 0.0, 1.0]}
  ]
}
```

Then rebuild and run:

```bash
python code/build_ski.py
skirt -i run -o run run/m12i_600.ski
```

## 6) Option B: Compute `dir` from angles

If you know the angles, compute the direction vector using:

```
dx = sin(theta) * cos(phi)
dy = sin(theta) * sin(phi)
dz = cos(theta)
```

Python example:

```python
import math

def dir_from_angles(theta_deg, phi_deg):
    theta = math.radians(theta_deg)
    phi = math.radians(phi_deg)
    dx = math.sin(theta) * math.cos(phi)
    dy = math.sin(theta) * math.sin(phi)
    dz = math.cos(theta)
    return dx, dy, dz

print(dir_from_angles(90.0, 45.0))
```

You can then insert those values into your `views.json` entry.

## 7) Option C: Replace `views.json` entirely

If you already have a custom `views.json`, copy it into place:

```bash
cp /path/to/my_views.json run/views.json
python code/build_ski.py
skirt -i run -o run run/m12i_600.ski
```

## 8) Required consistency rules

- `index` must be unique for each view.
- `dir` must be **unit length** (normalized). If it is not, normalize it.
- `theta_deg`/`phi_deg` should correspond to the given `dir` for clarity.
- After any change to `views.json`, you must rerun `code/build_ski.py`.

## 9) How filenames relate to view index

For view index `i`, outputs are named:

- `m12i_600_view_XXX_total.fits`
- `view_XXX` in PNG names

where `XXX` is a zero‑padded 3‑digit index from `views.json`.

## 10) If you want new views but the same pipeline

You can regenerate `views.json` from the existing script:

```bash
python code/make_views.py --num-views 64
python code/build_ski.py
skirt -i run -o run run/m12i_600.ski
```

This will create 64 uniform views using the Fibonacci sphere.

## 11) Camera positions (optional)

If you need actual camera coordinates at a fixed distance, use:

```bash
python code/camera_positions.py --views run/views.json --distance-mpc 10
```

This writes `camera_positions.txt` next to `views.json`.

## 12) Common mistakes to avoid

- Editing `views.json` but forgetting to rebuild the `.ski`.
- Non‑unit `dir` vectors.
- Duplicate indices.
- Using angles in radians instead of degrees when editing JSON.

